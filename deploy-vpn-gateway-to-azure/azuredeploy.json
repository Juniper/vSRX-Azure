{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",

    "parameters" : {
        "storageAccountName": {
          "type": "string",
          "metadata": {
            "description": "Storage Account Name"
          }
        },
        "vSRX-model": {
          "type": "string",
          "allowedValues": [
            "BYOL",
            "PAYG - w/Anti Virus"
          ],
          "metadata": {
            "description": "vSRX Model"
          },
          "defaultValue": "BYOL"
        },
        "vSRX-VirtualMachineSize": {
          "type": "string",
          "allowedValues": [
            "Standard_DS3_v2",
            "Standard_D4_v2",
            "Standard_DS5_v2"
          ],
          "metadata": {
            "description": "vSRX Virtual Machine Size"
          },
          "defaultValue": "Standard_DS3_v2"
        },
        "vsrx-name": {
          "type": "string",
          "metadata": {
            "description": "vSRX Name"
          },
          "defaultValue": "vsrx-gw"
        },
        "vsrx-vnet-name": {
          "type": "string",
          "metadata": {
            "description": "Virtual Network Name in which vSRX resides"
          },
          "defaultValue": "vsrx-vnet"
        },
        "vsrx-addr-ge-0-0-0": {
          "type": "string",
          "metadata": {
            "description": "vSRX ge-0/0/0 address"
          },
          "defaultValue": "192.168.10.20"
        },
        "vsrx-addr-ge-0-0-1": {
          "type": "string",
          "metadata": {
            "description": "vSRX ge-0/0/1 address"
          },
          "defaultValue": "192.168.20.20"
        },
        "vsrx-username": {
          "type": "string",
          "metadata": {
            "description": "vSRX user name"
          }
        },
        "authenticationType": {
            "type": "string",
            "allowedValues": [
            "password"
          ],
            "metadata": {
                "descritpion": "vSRX user authentication type"
            },
            "defaultValue": "Password"
        },
        "vsrx-password": {
          "type": "securestring",
          "metadata": {
            "description": "vSRX user password"
          }
        },
        "vsrx-vnet-prefix": {
          "type": "string",
          "metadata": {
            "description": "vSRX virtual network prefix"
          },
          "defaultValue": "192.168.0.0/16"
        },
        "vnet-mgt-subnet-name": {
          "type": "string",
          "metadata": {
            "description": "vSRX management subnet name"
          },
          "defaultValue": "Management"
        },
        "vnet-mgt-subnet-prefix": {
          "type": "string",
          "metadata": {
            "description": "vSRX management subnet prefix"
          },
          "defaultValue": "192.168.0.0/24"
        },
        "vnet-trust-subnet-name": {
          "type": "string",
          "metadata": {
            "description": "vSRX trust subnet name"
          },
          "defaultValue": "Trust"
        },
        "vnet-trust-subnet-prefix": {
          "type": "string",
          "metadata": {
            "description": "vSRX trust subnet prefix"
          },
          "defaultValue": "192.168.20.0/24"
        },
        "vnet-untrust-subnet-name": {
          "type": "string",
          "metadata": {
            "description": "vSRX untrust subnet name"
          },
          "defaultValue": "Untrust"
        },
        "vnet-untrust-subnet-prefix": {
          "type": "string",
          "metadata": {
            "description": "vSRX untrust subnet prefix"
          },
          "defaultValue": "192.168.10.0/24"
        },
        "vng-vnet-name": {
          "type": "string",
          "defaultValue": "vng-vnet",
          "metadata": {
            "description": "Virtual Network Name - this is where the Virtual Network Gateway will be deployed"
          }
        },
        "vng-vnet-prefix": {
          "type": "string",
          "defaultValue": "10.3.0.0/16",
          "metadata": {
            "description": "CIDR block representing the address space of the VNG VNet"
          }
        },
        "vng-vnet-mgt-subnet": {
          "type": "string",
          "defaultValue": "10.3.0.0/24",
          "metadata": {
            "description": "CIDR block representing the address space of the VNG VNet management subnet"
          }
        },
        "vng-vnet-private-subnet-prefix": {
          "type": "string",
          "defaultValue": "10.3.1.0/24",
          "metadata": {
            "description": "CIDR block representing the address space of the VNG VNet data subnet"
          }
        },
        "vng-vnet-mgt-subnet-name": {
          "type": "string",
          "defaultValue": "mgmt-subnet",
          "metadata": {
            "description": "Arbitrary name for the vng management subnet"
          }
        },
        "vng-vnet-private-subnet-name": {
          "type": "string",
          "defaultValue": "private-subnet",
          "metadata": {
            "description": "Arbitrary name for the vng private subnet"
          }
        },
        "local-gateway-name": {
          "type": "string",
          "defaultValue": "localGateway",
          "metadata": {
            "description": "Arbitrary name for gateway resource representing your local/on-prem gateway"
          }
        },
        "vng-vnet-gateway-subnet-prefix": {
          "type": "string",
          "defaultValue": "10.3.200.0/29",
          "metadata": {
            "description": "CIDR block for gateway subnet, subset of vng-vnet address space"
          }
        },
        "VNG-public-IP-name": {
          "type": "string",
          "defaultValue": "VNGPublicIP",
          "metadata": {
            "description": "Public IP address of the Virtual Network Gateway"
          }
        },
        "vng-name": {
          "type": "string",
          "defaultValue": "azureGateway",
          "metadata": {
            "description": "Arbitrary name for the Azure Virtual Network Gateway"
          }
        },
        "vpn-type": {
          "type": "String",
          "metadata": {
            "description": "Route based (Dynamic Gateway) or Policy based (Static Gateway)"
          },
          "defaultValue": "RouteBased",
          "allowedValues": [
            "RouteBased"
          ]
        },
        "vng-sku": {
          "type": "string",
          "defaultValue": "VpnGw1",
          "allowedValues": [
            "Basic",
            "VpnGw1",
            "VpnGw2",
            "VpnGw3"
          ],
          "metadata": {
            "description": "The Sku of the Virtual Network Gateway"
          }
        },
        "connection-name": {
          "type": "string",
          "defaultValue": "S2SConnection",
          "metadata": {
            "description": "Name of the VPN connection"
          }
        },
        "shared-key": {
          "type": "securestring",
          "metadata": {
            "description": "Shared key to create VPN connection between VNG and vSRX"
          }
        },
        "ubuntu-client-behind-vsrx": {
          "type": "string",
          "defaultValue": "Ubuntu-behind-vsrx",
          "metadata": {
            "description": "Client host name (ubuntu client behind vSRX)"
          }
        },
        "ubuntu-client-behind-vng": {
          "type": "string",
          "defaultValue": "Ubuntu-behind-vng",
          "metadata": {
            "description": "Client host name (ubuntu client behind Azure Virtual Network Gateway)"
          }
        },
        "ubuntu-client-virtual-machine-size": {
          "type": "string",
          "allowedValues": [
            "Standard_B1s",
            "Standard_DS3_v2",
            "Standard_B2s"
          ],
          "defaultValue": "Standard_B1s",
          "metadata": {
            "description": "Virtual machine size of the Ubuntu clients"
          }
        },
        "ubuntu-clients-username": {
          "type": "string",
          "defaultValue": "demo",
          "metadata": {
            "description": "Admin username of the Ubuntu clients"
          }
        },
        "ubuntu-clients-password": {
          "type": "securestring",
          "defaultValue": "Admin1234567",
          "metadata": {
            "description": "Admin password of the Ubuntu clients"
          }
        }
      },

    "variables": {
        "templateBaseUrl": "https://junipernetworks.blob.core.windows.net/vsrx-templates",
        "vsrxTemplateUrl": "[concat(variables('templateBaseUrl'), '/vSRX-', parameters('authenticationType'),'.json')]",
        "stagingTemplateUrl": "[concat(variables('templateBaseUrl'), '/staging-vm.json')]",
        "vngUbuntuTemplateUrl": "[concat(variables('templateBaseUrl'), '/vng-vm.json')]",
        "rbacTemplateUrl": "[concat(variables('templateBaseUrl'), '/createRBAC.json')]",
        "rgname" : "[resourceGroup().name]",
        "subId" : "[subscription().subscriptionId]",
        "agentRunCmd": "[concat('runcmd:\n -  [ /bin/sh, /opt/setup.sh ]\n\n')]",
        "storageAccountName": "[concat(parameters('storageAccountName'), uniqueString(resourceGroup().id))]",
        "vngVnetID": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vng-vnet-name'))]",
        "gatewaySubnetRef": "[concat(variables('vngVnetID'),'/subnets/','GatewaySubnet')]",
        "vngMgmtsubnetRef": "[concat(variables('vngVnetID'),'/subnets/',parameters('vng-vnet-mgt-subnet-name'))]",
        "vngDatasubnetRef": "[concat(variables('vngVnetID'),'/subnets/',parameters('vng-vnet-private-subnet-name'))]",
        "vsrx-addr-fxp0" : "[concat(parameters('vsrx-name'), '-fxp0')]",
        "vsrx-addr-ge000" : "[concat(parameters('vsrx-name'), '-ge-0-0-0')]",
        "vsrx-vnet-name":  "[parameters('vsrx-vnet-name')]",
        "vnet-mgt-subnet-name": "[concat(variables('vsrx-vnet-name'), '-', parameters('vnet-mgt-subnet-name'))]",
        "vnet-untrust-subnet-name": "[concat(variables('vsrx-vnet-name'), '-', parameters('vnet-untrust-subnet-name'))]",
        "vnet-trust-subnet-name": "[concat(variables('vsrx-vnet-name'), '-', parameters('vnet-trust-subnet-name'))]",
        "rtt-untrust": "[concat('rtt-untrust-subnet-', variables('vsrx-vnet-name'))]",
        "rtt-trust": "[concat('rtt-trust-subnet-', variables('vsrx-vnet-name'))]",
        "rtt-vng": "[concat('rtt-data-subnet-', parameters('vng-vnet-name'))]",
        "vsrxVM": {
            "vmSize": "[parameters('vSRX-VirtualMachineSize')]",
            "vmName": "[parameters('vsrx-name')]",
            "pipNameFxp0": "[variables('vsrx-addr-fxp0')]",
            "pipNameGe000": "[variables('vsrx-addr-ge000')]",
            "VNG-public-IP-name": "[parameters('VNG-public-IP-name')]",
            "mgtNicName": "[concat('if-', parameters('vsrx-name'), '-fxp0')]",
            "untrustNicName": "[concat('if-', parameters('vsrx-name'), '-ge-0-0-0')]",
            "untrustPrivateIP": "[parameters('vsrx-addr-ge-0-0-0')]",
            "trustNicName": "[concat('if-', parameters('vsrx-name'), '-ge-0-0-1')]",
            "trustPrivateIP": "[parameters('vsrx-addr-ge-0-0-1')]"
        },
        "vnet-id": "[resourceId('Microsoft.Network/virtualNetworks', variables('vsrx-vnet-name'))]",
        "vnet-untrust-subnet-id": "[concat(variables('vnet-id'),'/subnets/', variables('vnet-untrust-subnet-name'))]",
        "vnet-trust-subnet-id": "[concat(variables('vnet-id'),'/subnets/', variables('vnet-trust-subnet-name'))]",
        "vnet-mgt-subnet-id": "[concat(variables('vnet-id'),'/subnets/', variables('vnet-mgt-subnet-name'))]",

        "vsrx-pip-fxp0-id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('vsrxVM').pipNameFxp0)]",
        "vsrx-pip-ge000-id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('vsrxVM').pipNameGe000)]",
        "storageContainerName": "vsrx",
        "firstNetworkInterfaceName": "first-nic-ubuntu-1",
        "secondNetworkInterfaceName": "second-nic-ubuntu-1",
        "vngUbuntuFirstNetworkInterfaceName": "first-nic-ubuntu-2",
        "vngUbuntuSecondNetworkInterfaceName": "second-nic-ubuntu-2",
        "ubuntuPublicIpAddressName": "ubuntu-1-public-ip",
        "vngUbuntuPublicIpAddressName": "ubuntu-2-public-ip",
        "ubuntuPublicIpAddressType": "Dynamic",
        "sshKey" : "",

        "plan-byol": {
          "name": "vsrx-byol-azure-image",
          "publisher": "juniper-networks",
          "product": "vsrx-next-generation-firewall"
        },
        "plan-payg-b1": {
          "name": "vsrx-azure-image-payg-b1",
          "publisher": "juniper-networks",
          "product": "vsrx-next-generation-firewall-payg"
        },
        "image-byol": {
          "publisher": "juniper-networks",
          "offer": "vsrx-next-generation-firewall",
          "sku": "vsrx-byol-azure-image",
          "version": "latest"
        },
        "image-payg-b1": {
          "publisher": "juniper-networks",
          "offer": "vsrx-next-generation-firewall-payg",
          "sku": "vsrx-azure-image-payg-b1",
          "version": "latest"
        },

        "linuxConfigurationSshPublicKey": {
            "disablePasswordAuthentication": "true",
            "ssh": {
              "publicKeys": [
              {
                "path": "[concat('/home/', parameters('vsrx-username'), '/.ssh/authorized_keys')]",
                "keyData": "[variables('sshKey')]"
              }
             ]
           }
        },
        "linuxConfigurationPassword": {
          "disablePasswordAuthentication": "false"
        }
    },

    "resources": [ 
        {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('storageAccountName')]",
            "apiVersion": "2017-06-01",
            "location": "[resourceGroup().location]",
            "kind": "Storage",
	          "sku": {
	            "name": "Standard_LRS"
	          }
        }, 
        {
          "apiVersion": "2015-06-15",
          "type": "Microsoft.Network/virtualNetworks",
          "name": "[parameters('vng-vnet-name')]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
                 "[concat('Microsoft.Network/routeTables/', variables('rtt-vng'))]"
               ],
          "properties": {
            "addressSpace": {
              "addressPrefixes": [
                "[parameters('vng-vnet-prefix')]"
              ]
            },
            "subnets": [
              {
                "name": "[parameters('vng-vnet-mgt-subnet-name')]",
                "properties": {
                  "addressPrefix": "[parameters('vng-vnet-mgt-subnet')]"
                }
              },
              { 
                "name": "[parameters('vng-vnet-private-subnet-name')]",
                "properties": {
                  "addressPrefix": "[parameters('vng-vnet-private-subnet-prefix')]",
                  "routeTable": {
                    "id": "[resourceId('Microsoft.Network/routeTables', variables('rtt-vng'))]"
                  }
                }
              },
              {
                "name": "GatewaySubnet",
                "properties": {
                  "addressPrefix": "[parameters('vng-vnet-gateway-subnet-prefix')]"
                }
              }
            ]
          }
        },
        {
            "apiVersion": "2015-06-15",
            "type": "Microsoft.Network/routeTables",
            "name": "[variables('rtt-vng')]",
            "location": "[resourceGroup().location]",
            "tags": {
              "displayName": "RTT - Data subnet"
            },
            "properties": {
              "routes": [
                {
                  "name": "RouteToAny",
                  "properties": {
                    "addressPrefix": "0.0.0.0/0",
                    "nextHopType": "VirtualNetworkGateway"
                  }
                }
              ]
            }
        },
        {
          "apiVersion": "2016-03-30",
          "type": "Microsoft.Network/publicIPAddresses",
          "name": "[parameters('VNG-public-IP-name')]",
          "location": "[resourceGroup().location]",
          "properties": {
            "publicIPAllocationMethod": "Dynamic"
          }
        },
        {
          "apiVersion": "2017-10-01",
          "type": "Microsoft.Network/localNetworkGateways",
          "name": "[parameters('local-gateway-name')]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
                 "[concat('Microsoft.Network/publicIPAddresses/', variables('vsrxVM').pipNameGe000)]"
               ],
          "properties": {
            "localNetworkAddressSpace": {
              "addressPrefixes": [
                "[parameters('vnet-trust-subnet-prefix')]"
              ]
            },
            "gatewayIpAddress": "[reference(resourceId('Microsoft.Network/publicIPAddresses',variables('vsrxVM').pipNameGe000)).IpAddress]"
          }
        },
        {
          "apiVersion": "2017-10-01",
          "type": "Microsoft.Network/virtualNetworkGateways",
          "name": "[parameters('vng-name')]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[concat('Microsoft.Network/publicIPAddresses/', parameters('VNG-public-IP-name'))]",
            "[concat('Microsoft.Network/virtualNetworks/', parameters('vng-vnet-name'))]"
          ],
          "properties": {
            "ipConfigurations": [
              {
                "properties": {
                  "privateIPAllocationMethod": "Dynamic",
                  "subnet": {
                    "id": "[variables('gatewaySubnetRef')]"
                  },
                  "publicIPAddress": {
                    "id": "[resourceId('Microsoft.Network/publicIPAddresses',parameters('VNG-public-IP-name'))]"
                  }
                },
                "name": "vnetGatewayConfig"
              }
            ],
            "sku": {
              "name": "[parameters('vng-sku')]",
              "tier": "[parameters('vng-sku')]"
            },
            "gatewayType": "Vpn",
            "vpnType": "[parameters('vpn-type')]",
            "enableBgp": "false"
          }
        },
        {
          "apiVersion": "2017-10-01",
          "name": "[parameters('connection-name')]",
          "type": "Microsoft.Network/connections",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[concat('Microsoft.Network/virtualNetworkGateways/', parameters('vng-name'))]",
            "[concat('Microsoft.Network/localNetworkGateways/', parameters('local-gateway-name'))]"
          ],
          "properties": {
            "virtualNetworkGateway1": {
              "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('vng-name'))]"
            },
            "localNetworkGateway2": {
              "id": "[resourceId('Microsoft.Network/localNetworkGateways', parameters('local-gateway-name'))]"
            },
            "connectionType": "IPsec",
            "routingWeight": 10,
            "sharedKey": "[parameters('shared-key')]"
          }
        },
            {
              "apiVersion": "2016-09-01",
              "name": "stagingVM",
              "type": "Microsoft.Resources/deployments",
               "dependsOn": [
                 "[concat('Microsoft.Network/networkInterfaces/', variables('firstNetworkInterfaceName'))]",
                 "[concat('Microsoft.Network/networkInterfaces/', variables('secondNetworkInterfaceName'))]",
                 "[concat('Microsoft.Network/publicIPAddresses/', parameters('VNG-public-IP-name'))]",
                 "[concat('Microsoft.Network/virtualNetworkGateways/', parameters('vng-name'))]"
               ],
               "properties": {
                 "mode": "Incremental",
                 "templateLink": {
                   "uri": "[variables('stagingTemplateUrl')]",
                   "contentVersion": "1.0.0.0"
                },
                "parameters": {
                  "location": {
                    "value": "[resourceGroup().location]"
                  },
                  "vmName": {
                    "value": "[parameters('ubuntu-client-behind-vsrx')]"
                  },
                  "vmUsername": {
                    "value": "[parameters('ubuntu-clients-username')]"
                  },
                  "vmPassword": {
                    "value": "[parameters('ubuntu-clients-password')]"
                  },
                  "vsrxPublicIP": {
                    "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses',variables('vsrxVM').pipNameFxp0)).IpAddress]"
                  },
                  "vsrxPassword": {
                    "value": "[parameters('vsrx-password')]"
                  },
                  "untrustPrivateIP": {
                    "value": "[variables('vsrxVM').untrustPrivateIP]"
                  },
                  "untrustSubnetPrefix": {
                    "value": "[parameters('vnet-untrust-subnet-prefix')]"
                  },
                  "trustPrivateIP": {
                    "value": "[variables('vsrxVM').trustPrivateIP]"
                  },
                  "trustSubnetPrefix": {
                    "value": "[parameters('vnet-trust-subnet-prefix')]"
                  },
                  "agentRunCmd": {
                    "value": "[variables('agentRunCmd')]"
                  },
                  "vpnSharedKey": {
                    "value": "[parameters('shared-key')]"
                  },
                  "localAddressPrefix": {
                    "value": "[parameters('vnet-trust-subnet-prefix')]"
                  },
                  "remoteAddressSpace": {
                    "value": "[parameters('vng-vnet-private-subnet-prefix')]"
                  },
                  "resourceGroupName": {
                    "value": "[variables('rgname')]"
                  },
                  "subscriptionId": {
                    "value": "[variables('subId')]"
                  },
                  "vngName": {
                    "value": "[parameters('vng-name')]"
                  },
                  "firstNICName": {
                    "value": "[variables('firstNetworkInterfaceName')]"
                  },
                  "secondNICName": {
                    "value": "[variables('secondNetworkInterfaceName')]"
                  },
                  "vmSize": {
                    "value": "[parameters('ubuntu-client-virtual-machine-size')]"
                  },
                  "vsrxUsername": {
                    "value": "[parameters('vsrx-username')]"
                  },
                  "sshKey": {
                    "value": "[variables('sshKey')]"
                  }
                }
              }
            },
            {
              "apiVersion": "2016-09-01",
              "name": "creatingRBAC",
              "type": "Microsoft.Resources/deployments",
               "dependsOn": [
                 "[concat('Microsoft.Resources/deployments/', 'stagingVM')]"
               ],
               "properties": {
                 "mode": "Incremental",
                 "templateLink": {
                   "uri": "[variables('rbacTemplateUrl')]",
                   "contentVersion": "1.0.0.0"
                 },
                 "parameters": {
                  "principalId": {
                    "value": "[reference('Microsoft.Resources/deployments/stagingVM', '2016-09-01').outputs.principalId.value]"
                  },
                  "builtInRoleType": {
                    "value": "Reader"
                  },
                  "roleNameGuid": {
                    "value": "[reference('Microsoft.Resources/deployments/stagingVM', '2016-09-01').outputs.guid0.value]"
                  }
                }
              }
            }, 
            {
              "apiVersion": "2016-06-01",
              "name": "vngUbuntu",
              "type": "Microsoft.Resources/deployments",
               "dependsOn": [
                 "[concat('Microsoft.Network/networkInterfaces/', variables('vngUbuntuFirstNetworkInterfaceName'))]",
                 "[concat('Microsoft.Network/networkInterfaces/', variables('vngUbuntuSecondNetworkInterfaceName'))]"
               ],
               "properties": {
                 "mode": "Incremental",
                 "templateLink": {
                   "uri": "[variables('vngUbuntuTemplateUrl')]",
                   "contentVersion": "1.0.0.0"
                },
                "parameters": {
                  "location": {
                    "value": "[resourceGroup().location]"
                  },
                  "vmName": {
                    "value": "[parameters('ubuntu-client-behind-vng')]"
                  },
                  "vmUsername": {
                    "value": "[parameters('ubuntu-clients-username')]"
                  },
                  "vmPassword": {
                    "value": "[parameters('ubuntu-clients-password')]"
                  },
                  "agentRunCmd": {
                    "value": "[variables('agentRunCmd')]"
                  },
                  "firstNICName": {
                    "value": "[variables('vngUbuntuFirstNetworkInterfaceName')]"
                  },
                  "secondNICName": {
                    "value": "[variables('vngUbuntuSecondNetworkInterfaceName')]"
                  },
                  "remoteAddressSpace": {
                    "value": "[parameters('vng-vnet-private-subnet-prefix')]"
                  },
                  "vmSize": {
                    "value": "[parameters('ubuntu-client-virtual-machine-size')]"
                  },
                  "remoteAddressSpace": {
                    "value": "[parameters('vng-vnet-private-subnet-prefix')]"
                  },
                  "trustSubnetPrefix": {
                    "value": "[parameters('vnet-trust-subnet-prefix')]"
                  }
                }
              }
            },
            {
                "name": "[variables('firstNetworkInterfaceName')]",
                "type": "Microsoft.Network/networkInterfaces",
                "apiVersion": "2016-09-01",
                "location": "[resourceGroup().location]",
                "dependsOn": [
                  "[concat('Microsoft.Network/publicIpAddresses/', variables('ubuntuPublicIpAddressName'))]",
                  "[concat('Microsoft.Network/virtualNetworks/', variables('vsrx-vnet-name'))]"
                ],
                "properties": {
                    "ipConfigurations": [
                        {
                            "name": "ipconfig1",
                            "properties": {
                                "subnet": {
                                    "id": "[variables('vnet-mgt-subnet-id')]"
                                },
                                "privateIPAllocationMethod": "Dynamic",
                                "publicIpAddress": {
                                    "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('ubuntuPublicIpAddressName'))]"
                                }
                            }
                        }
                    ]
                }
            },
            {
                "name": "[variables('secondNetworkInterfaceName')]",
                "type": "Microsoft.Network/networkInterfaces",
                "apiVersion": "2016-09-01",
                "location": "[resourceGroup().location]",
                "dependsOn": [
                 "[concat('Microsoft.Network/virtualNetworks/', variables('vsrx-vnet-name'))]"
               ],
                "properties": {
                    "ipConfigurations": [
                        {
                            "name": "ipconfig1",
                            "properties": {
                                "subnet": {
                                    "id": "[variables('vnet-trust-subnet-id')]"
                                },
                                "privateIPAllocationMethod": "Dynamic"
                            }
                        }
                    ]
                }
            },
            {
                "name": "[variables('ubuntuPublicIpAddressName')]",
                "type": "Microsoft.Network/publicIpAddresses",
                "apiVersion": "2016-09-01",
                "location": "[resourceGroup().location]",
                "properties": {
                    "publicIpAllocationMethod": "[variables('ubuntuPublicIpAddressType')]"
                }
            },
            {   
                "name": "[variables('vngUbuntuFirstNetworkInterfaceName')]",
                "type": "Microsoft.Network/networkInterfaces",
                "apiVersion": "2016-09-01",
                "location": "[resourceGroup().location]",
                "dependsOn": [
                  "[concat('Microsoft.Network/publicIpAddresses/', variables('vngUbuntuPublicIpAddressName'))]",
                  "[concat('Microsoft.Network/virtualNetworks/', parameters('vng-vnet-name'))]"
                ],
                "properties": {
                    "ipConfigurations": [
                        {   
                            "name": "ipconfig1",
                            "properties": {
                                "subnet": {
                                    "id": "[variables('vngMgmtsubnetRef')]"
                                },
                                "privateIPAllocationMethod": "Dynamic",
                                "publicIpAddress": {
                                    "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('vngUbuntuPublicIpAddressName'))]"
                                }
                            }
                        }
                    ]
                }
            },
            {
                "name": "[variables('vngUbuntuSecondNetworkInterfaceName')]",
                "type": "Microsoft.Network/networkInterfaces",
                "apiVersion": "2016-09-01",
                "location": "[resourceGroup().location]",
                "dependsOn": [
                 "[concat('Microsoft.Network/virtualNetworks/', parameters('vng-vnet-name'))]"
               ],
                "properties": {
                    "ipConfigurations": [
                        {
                            "name": "ipconfig1",
                            "properties": {
                                "subnet": {
                                    "id": "[variables('vngDatasubnetRef')]"
                                },
                                "privateIPAllocationMethod": "Dynamic"
                            }
                        }
                    ]
                }
            },
            {
                "name": "[variables('vngUbuntuPublicIpAddressName')]",
                "type": "Microsoft.Network/publicIpAddresses",
                "apiVersion": "2016-09-01",
                "location": "[resourceGroup().location]",
                "properties": {
                    "publicIpAllocationMethod": "[variables('ubuntuPublicIpAddressType')]"
                }
            },
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "name": "[variables('vsrxVM').pipNameFxp0]",
              "apiVersion": "2016-03-30",
              "location": "[resourceGroup().location]",
              "properties": {
                "publicIPAllocationMethod": "Static",
                "dnsSettings": {
                  "domainNameLabel": "[concat(variables('vsrxVM').pipNameFxp0, uniqueString(resourceGroup().location))]"
                }
              }
            },
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "name": "[variables('vsrxVM').pipNameGe000]",
              "apiVersion": "2016-03-30",
              "location": "[resourceGroup().location]",
              "properties": {
                "publicIPAllocationMethod": "Static",
                "dnsSettings": {
                  "domainNameLabel": "[concat(variables('vsrxVM').pipNameGe000, uniqueString(resourceGroup().location))]"
                }
              }
            },
            {
               "apiVersion": "2016-03-30",
               "type": "Microsoft.Network/virtualNetworks",
               "name": "[variables('vsrx-vnet-name')]",
               "location": "[resourceGroup().location]",
               "dependsOn": [
                 "[concat('Microsoft.Network/routeTables/', variables('rtt-untrust'))]",
                 "[concat('Microsoft.Network/routeTables/', variables('rtt-trust'))]"
               ],
               "properties": {
                 "addressSpace": {
                   "addressPrefixes": [
                     "[parameters('vsrx-vnet-prefix')]"
                   ]
                 },
                 "subnets": [
                   {
                     "name": "[variables('vnet-mgt-subnet-name')]",
                     "properties": {
                         "addressPrefix": "[parameters('vnet-mgt-subnet-prefix')]"
                     }
                   },
                   {
                     "name": "[variables('vnet-untrust-subnet-name')]",
                     "properties": {
                         "addressPrefix": "[parameters('vnet-untrust-subnet-prefix')]",
                         "routeTable": {
                             "id": "[resourceId('Microsoft.Network/routeTables', variables('rtt-untrust'))]"
                         }
                     }
                   },
                   {
                     "name": "[variables('vnet-trust-subnet-name')]",
                     "properties": {
                         "addressPrefix": "[parameters('vnet-trust-subnet-prefix')]",
                         "routeTable": {
                             "id": "[resourceId('Microsoft.Network/routeTables', variables('rtt-trust'))]"
                         }
                     }
                   }
                 ]
               }
            },
            {
                "apiVersion": "2015-06-15",
                "type": "Microsoft.Network/routeTables",
                "name": "[variables('rtt-untrust')]",
                "location": "[resourceGroup().location]",
                "tags": {
                  "displayName": "RTT - Untrust subnet"
                },
                "properties": {
                  "routes": [
                    {
                      "name": "RouteToAny",
                      "properties": {
                        "addressPrefix": "0.0.0.0/0",
                        "nextHopType": "Internet"
                      }
                    }
                  ]
                }
            },
            {
                "apiVersion": "2015-06-15",
                "type": "Microsoft.Network/routeTables",
                "name": "[variables('rtt-trust')]",
                "location": "[resourceGroup().location]",
                "tags": {
                  "displayName": "RTT - Trust subnet"
                },
                "properties": {
                  "routes": [
                    {
                      "name": "RouteToAny",
                      "properties": {
                        "addressPrefix": "0.0.0.0/0",
                        "nextHopType": "VirtualAppliance",
                        "nextHopIpAddress": "[parameters('vsrx-addr-ge-0-0-1')]"
                      }
                    }
                  ]
                }
            },
            {
               "apiVersion": "2016-03-30",
               "type": "Microsoft.Network/networkInterfaces",
               "name": "[variables('vsrxVM').mgtNicName]",
               "location": "[resourceGroup().location]",
               "dependsOn": [
                 "[concat('Microsoft.Network/virtualNetworks/', variables('vsrx-vnet-name'))]",
                 "[concat('Microsoft.Network/publicIPAddresses/', variables('vsrxVM').pipNameFxp0)]"
               ],
               "properties": {
                 "ipConfigurations": [
                   {
                     "name": "ipconfig1",
                     "properties": {
                       "privateIPAllocationMethod": "Dynamic",
                       "publicIPAddress": {
                         "id": "[variables('vsrx-pip-fxp0-id')]"
                       },
                       "subnet": {
                         "id": "[variables('vnet-mgt-subnet-id')]"
                       }
                     }
                   }
                 ]
               }
            },
            {
               "apiVersion": "2016-03-30",
               "type": "Microsoft.Network/networkInterfaces",
               "name": "[variables('vsrxVM').untrustNicName]",
               "location": "[resourceGroup().location]",
               "dependsOn": [
                 "[concat('Microsoft.Network/virtualNetworks/', variables('vsrx-vnet-name'))]",
                 "[concat('Microsoft.Network/publicIPAddresses/', variables('vsrxVM').pipNameGe000)]"
               ],
               "properties": {
                 "ipConfigurations": [
                   {
                     "name": "ipconfig1",
                     "properties": {
                       "privateIPAllocationMethod": "Static",
                       "privateIPAddress": "[variables('vsrxVM').untrustPrivateIP]",
                       "publicIPAddress": {
                         "id": "[variables('vsrx-pip-ge000-id')]"
                       },
                       "subnet": {
                         "id": "[variables('vnet-untrust-subnet-id')]"
                       }
                     }
                   }
                 ]
               }
            },
            {
               "apiVersion": "2016-03-30",
               "type": "Microsoft.Network/networkInterfaces",
               "name": "[variables('vsrxVM').trustNicName]",
               "location": "[resourceGroup().location]",
               "dependsOn": [
                 "[concat('Microsoft.Network/virtualNetworks/', variables('vsrx-vnet-name'))]"
               ],
               "properties": {
                 "ipConfigurations": [
                   {
                     "name": "ipconfig1",
                     "properties": {
                       "privateIPAllocationMethod": "Static",
                       "privateIPAddress": "[variables('vsrxVM').trustPrivateIP]",
                       "subnet": {
                         "id": "[variables('vnet-trust-subnet-id')]"
                       }
                     }
                   }
                 ],
                 "enableIPForwarding": true
               }
            },
            {
              "apiVersion": "2016-03-30",
              "name": "[variables('vsrxVM').vmName]",
              "type": "Microsoft.Compute/virtualMachines",
              "location": "[resourceGroup().location]",
              "plan": "[if(equals(parameters('vSRX-model'), 'BYOL'), variables('plan-byol'), variables('plan-payg-b1'))]",
              "dependsOn": [
                 "[concat('Microsoft.Network/networkInterfaces/', variables('vsrxVM').mgtNicName)]",
                 "[concat('Microsoft.Network/networkInterfaces/', variables('vsrxVM').untrustNicName)]",
                 "[concat('Microsoft.Network/networkInterfaces/', variables('vsrxVM').trustNicName)]",
                 "[concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]"
               ],
              "properties": {
                      "hardwareProfile": {
                        "vmSize": "[variables('vsrxVM').vmSize]"
                      },
                    "storageProfile": {
                      "imageReference": "[if(equals(parameters('vSRX-model'), 'BYOL'), variables('image-byol'), variables('image-payg-b1'))]",
                      "osDisk": {
                          "osType": "Linux",
                          "name": "[concat(variables('vsrxVM').vmName, '-Disk')]",
                          "vhd": {
                            "uri": "[concat(reference(concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName')), '2017-06-01').primaryEndpoints.blob, variables('storageContainerName'), '/', variables('vsrxVM').vmName, uniquestring(resourceGroup().id), '.vhd')]"
                          },
                          "caching": "ReadWrite",
                          "createOption": "FromImage"
                      }
                      },
                      "osProfile": {
                        "computerName": "[variables('vsrxVM').vmName]",
                        "adminUsername": "[parameters('vsrx-username')]",
                        "adminPassword": "[if(equals(parameters('authenticationType'), 'password'), parameters('vsrx-password'), json('null'))]",

                        "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), variables('linuxConfigurationPassword'), variables('linuxConfigurationSshPublicKey'))]"
                      },
                      "networkProfile": {
                        "networkInterfaces": [
                          {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('vsrxVM').mgtNicName)]",
                            "properties": {
                                "primary": true
                            }
                          },
                          {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('vsrxVM').untrustNicName)]",
                            "properties": {
                                "primary": false
                            }
                          },
                          {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('vsrxVM').trustNicName)]",
                            "properties": {
                                "primary": false
                            }
                          }
                        ]
                      },
                      "diagnosticsProfile": {
                        "bootDiagnostics": {
                          "enabled": true,
                          "storageUri": "[reference(concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName')), '2017-06-01').primaryEndpoints.blob]"
                        }
                      }
                  }
            }
     ],
          
  "outputs": {  }
}
